language: generic
env:
  global:
    - secure: "viT42Eq7SH45EhhGO28LBdRyPTaBLhhS4sN7Y6gPOy4MwDgS/f+A5Q4dbSaCiSfDeDt8nLQ9T+k2bkLqChAaR6nkaeZ/pJWXI2lkA7gha4fDk+oNG2lJ71O4sKrxJrUrUYAxmfAvWzktdFnjb1Ifg+Zrz8/k0hR7T9/cXFHBXQeBQbaE2ZEbLLMw7mHIGjeUIaJ4gScCELCP3TrCAJzzTOWontEkz5kmXbUeLJ4jnSukhPcM5sQpnPOusqPei+FRpcdp+Y/jBsClr911B2GJC2MD3dFo3LyLoC1bNjNwWs63FmmfTsaECd9ZoeQrRmd5qgWwRBTMoNa5eV/di72K9sV69SXtbo/Y/qxnvfDvmEhlrfB1PqEvD6P9HwXwSZmyHdmj9qHgZtBhdYdqm2WsYFTUwEuduGmEAReTCXVlzT1P02ih8k9i5NAo/bFW//0v2JDTsOQ0iCopEvGQUVJchw04eL0s9PkrlUAjv5RxrZRRJnNZevLdnKJYIc97iuUTJYtKPoFzA+rxsa6uyt8b/2X08UUY1sfX1rv1/nmE4tcIfM3bRvQFWZ5s4altROzq8sFOjNM4mXFRWvjo70+Zbe3ogvO3A8FMEb11g+7RadqW1EmWfoZsb5RO8VH0zxX+xyEmBKzu6eKEijiMHKWxUqAtcBBPOM51BRrgnk/I4FU="
matrix:
  include:
    - os: linux
    - os: osx
before_install:
  # make sure, gfortran and gnu-sed are installed
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew install gnu-sed --with-default-names;
    fi
  - sed -i 's/git@github.com:/https:\/\/github.com\//' .gitmodules
git:
    submodules: false
install:
  # unset the global SWITCH_DRIVE_PW variable because it is not needed during
  # the installation process. This decreases the vulnerability
  - SWITCH_DRIVE_PW_SAVE=$SWITCH_DRIVE_PW
  - unset SWITCH_DRIVE_PW
  # checkout submodules (but not recursively)
  - git submodule update --init
  # select the os name for the conda installer
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
        export OS_NAME=MacOSX;
    else
        export OS_NAME=Linux;
    fi
  # We do this conditionally because it saves us some downloading if the
  # version is the same.
  - wget https://repo.continuum.io/miniconda/Miniconda3-latest-"${OS_NAME}"-x86_64.sh -O miniconda.sh;
  - 'echo "backend : module://psyplot_gui.backend" > matplotlibrc'
  - bash miniconda.sh -b -p $HOME/miniconda
  - export ORIG_PATH=$PATH
  - export PATH="$HOME/miniconda/bin:$ORIG_PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda
  # Useful for debugging any issues with conda
  - conda info -a
  - if [[ $TRAVIS_TAG == "" ]]; then
        ARGS="";
    else
        ARGS="-v $TRAVIS_TAG";
    fi
  # update conda
  - conda env update -f environment.yml -n root
  - conda install constructor conda-build
  # install the submodules
  - cd psyplot && python setup.py install && cd ../
  - cd psyplot-gui && python setup.py install && cd ../
  - cd psy-simple && python setup.py install && cd ../
  - cd psy-maps && python setup.py install && cd ../
  - cd psy-reg && python setup.py install && cd ../
  # prepare the recipes
  - python recipe_from_setup.py psyplot recipes
  - python recipe_from_setup.py psyplot-gui psyplot-gui/ci/conda_recipe
  - python recipe_from_setup.py psy-simple recipes
  - python recipe_from_setup.py psy-maps recipes
  - python recipe_from_setup.py psy-reg recipes
  # link the already downloaded conda packages to the constructor config to
  # speed up the build
  - CONSTRUCTOR_CONFIG=$HOME/.conda/constructor/$TRAVIS_OS_NAME-64
  - if [[ ! -e $CONSTRUCTOR_CONFIG ]]; then
        mkdir -p $CONSTRUCTOR_CONFIG;
    fi
  - for f in $HOME/miniconda/pkgs/*.tar.bz2; do
        ln -s $f "${CONSTRUCTOR_CONFIG}/`basename $f`";
    done
  # update psy-simple and psy-maps reference figures submodules
  - cd psy-simple && git submodule update --init `python tests/get_ref_dir.py` && cd ..
  - cd psy-maps && git submodule update --init `python tests/get_ref_dir.py` && cd ..
  # print debugging informations
  - conda env export -n root
  # print versions of all the important requirements
  - psyplot -aV
  # export the pw to make it available for the deploy
  - export SWITCH_DRIVE_PW=$SWITCH_DRIVE_PW_SAVE

before_script:
  - if [[ $TRAVIS_OS_NAME == "linux" ]]; then
        export "DISPLAY=:99.0";
        sh -e /etc/init.d/xvfb start;
        sleep 3;
    fi

script:
  # build the receipts and prepare the constructor files
  - python prepare_constructor_files.py recipes/* psyplot-gui/ci/conda_recipe/psyplot-gui $ARGS
  # construct the executable
  - constructor psyplot-conda
  # execute the executable
  - bash psyplot-conda-*-"${OS_NAME}"-*.sh -p $HOME/psyplot-conda -b
  # export the new path and remove current miniconda installation
  - export PATH="$HOME/miniconda/bin:$ORIG_PATH" && hash -r
  # install pytest
  - pip install pytest
  # run tests for psyplot
  - py.test -v psyplot
  # run tests for psyplot-gui
  - py.test -v psyplot-gui
  # run (some) tests for psy-simple
  - py.test -v psy-simple -k "LinePlotterTest2D or Simple2DPlotterTest2D"
  # run (some) tests for psy-maps
  - py.test -v psy-maps -k "FieldPlotterTest2D and not Circumpolar"
  # run tests for psy-reg
  - py.test -v psy-reg

before_deploy:
    - export FINAL_FILE=$(ls psyplot-conda-*-"${OS_NAME}"-*.sh)

deploy:
  - provider: script
    script: ci/deploy_nightly.sh "philipp.sommer@unil.ch:$SWITCH_DRIVE_PW" "$FINAL_FILE"
    skip_cleanup: true
    on:
      all_branches: true
      # do not deploy releases
      condition: '$TRAVIS_TAG == ""'

